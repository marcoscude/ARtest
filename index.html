<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>ARbiblio - Esperienza Biblioteca Parma</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <!-- A-Frame con WebXR support -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      /* Overlay iniziale per trovare il marker */
      #markerOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 20px;
        box-sizing: border-box;
      }

      #markerOverlay h2 {
        margin: 0 0 20px 0;
        font-size: 22px;
        text-align: center;
      }

      #markerOverlay p {
        margin: 0 0 20px 0;
        font-size: 14px;
        text-align: center;
        opacity: 0.8;
      }

      #markerOverlay img {
        max-width: 200px;
        border: 3px solid white;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      #startARBtn {
        background: #CC0000;
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(204, 0, 0, 0.4);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #startARBtn:active {
        transform: scale(0.95);
      }

      #startARBtn:disabled {
        background: #666;
        cursor: not-allowed;
      }

      /* Messaggio di stato */
      #statusMessage {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 14px;
        z-index: 100;
        display: none;
      }

      /* Istruzioni AR */
      #arInstructions {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 14px;
        z-index: 100;
        display: none;
        text-align: center;
      }

      /* Bottone per posizionare oggetti */
      #placeObjectsBtn {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        background: #00AA00;
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: bold;
        z-index: 100;
        cursor: pointer;
        display: none;
        box-shadow: 0 6px 20px rgba(0, 170, 0, 0.4);
      }

      /* Reticolo di mira */
      #reticle {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 3px solid white;
        border-radius: 50%;
        z-index: 50;
        display: none;
        pointer-events: none;
      }

      #reticle::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
      }

      /* Errore WebXR */
      #webxrError {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(200,0,0,0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 2000;
        display: none;
        max-width: 300px;
      }

      /* Debug panel */
      #debugPanel {
        position: fixed;
        top: 80px;
        right: 10px;
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 15px;
        border-radius: 10px;
        font-size: 11px;
        z-index: 99;
        max-width: 280px;
        display: none;
      }

      #debugToggle {
        position: fixed;
        top: 80px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        border: 1px solid #00FFAA;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        z-index: 100;
        cursor: pointer;
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- Overlay iniziale -->
    <div id="markerOverlay">
      <h2>Trova il Marker</h2>
      <p>Cerca questo marker nell'ambiente intorno a te</p>
      <img src="./assets/Markernote1.png" alt="Marker da trovare">
      <p>Quando lo hai trovato, premi il bottone</p>
      <button id="startARBtn">Avvia Esperienza AR</button>
      <p id="compatibilityMsg" style="margin-top: 20px; color: #ffcc00;"></p>
    </div>

    <!-- Messaggio di stato -->
    <div id="statusMessage"></div>

    <!-- Istruzioni AR -->
    <div id="arInstructions">
      Muovi lentamente il telefono per scansionare l'ambiente.<br>
      Punta verso una superficie piana.
    </div>

    <!-- Reticolo di mira -->
    <div id="reticle"></div>

    <!-- Bottone posiziona -->
    <button id="placeObjectsBtn">Posiziona Oggetti Qui</button>

    <!-- Errore WebXR -->
    <div id="webxrError">
      <h3>AR Non Supportato</h3>
      <p>Il tuo browser non supporta WebXR AR.<br>Usa Chrome su Android o Safari su iOS.</p>
    </div>

    <!-- Toggle Debug -->
    <button id="debugToggle" style="display: none;">‚öôÔ∏è Debug</button>

    <!-- A-Frame Scene con WebXR -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; colorManagement: true;"
      webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #markerOverlay;"
    >
      <!-- Assets -->
      <a-assets timeout="30000">
        <a-asset-item id="model-biblioteca-sx" src="./assets/2.3_Biblioteca.glb"></a-asset-item>
        <a-asset-item id="model-biblioteca-centro" src="./assets/2.4_BibliotecaParma_2.glb"></a-asset-item>
        <a-asset-item id="model-piani-dx" src="./assets/2.5_PianiParma.glb"></a-asset-item>
      </a-assets>

      <!-- Container per oggetti AR (inizialmente nascosto) -->
      <a-entity id="arObjects" visible="false">
        <!-- 2.3_Biblioteca - SINISTRA -->
        <a-entity
          id="biblioteca-sx"
          gltf-model="#model-biblioteca-sx"
          position="-1 0 0"
          scale="0.3 0.3 0.3"
          rotation="0 0 0"
        ></a-entity>

        <!-- 2.4_BibliotecaParma_2 - CENTRO -->
        <a-entity
          id="biblioteca-centro"
          gltf-model="#model-biblioteca-centro"
          position="0 0 -0.5"
          scale="0.3 0.3 0.3"
          rotation="0 0 0"
        ></a-entity>

        <!-- 2.5_PianiParma - DESTRA -->
        <a-entity
          id="piani-dx"
          gltf-model="#model-piani-dx"
          position="1 0 0"
          scale="0.3 0.3 0.3"
          rotation="0 0 0"
        ></a-entity>
      </a-entity>

      <!-- Reticolo 3D per hit-test -->
      <a-entity id="reticle3d" visible="false">
        <a-ring
          color="#00FF00"
          radius-inner="0.04"
          radius-outer="0.06"
          rotation="-90 0 0"
        ></a-ring>
      </a-entity>

      <!-- Camera -->
      <a-entity id="camera" camera></a-entity>

    </a-scene>

    <script>
      // =============================================================================
      // ARBIBLIO - WebXR AR con Hit-Testing
      // Ancoraggio spaziale reale tramite scansione ambiente
      // =============================================================================

      console.log('üöÄ ARbiblio WebXR inizializzato');

      // Stato
      let xrSession = null;
      let hitTestSource = null;
      let reticlePosition = null;
      let objectsPlaced = false;

      // Elementi DOM
      const markerOverlay = document.getElementById('markerOverlay');
      const startARBtn = document.getElementById('startARBtn');
      const statusMessage = document.getElementById('statusMessage');
      const arInstructions = document.getElementById('arInstructions');
      const placeObjectsBtn = document.getElementById('placeObjectsBtn');
      const reticle = document.getElementById('reticle');
      const webxrError = document.getElementById('webxrError');
      const debugToggle = document.getElementById('debugToggle');
      const compatibilityMsg = document.getElementById('compatibilityMsg');

      // Elementi A-Frame
      const scene = document.getElementById('scene');
      const arObjects = document.getElementById('arObjects');
      const reticle3d = document.getElementById('reticle3d');

      // =============================================================================
      // CHECK COMPATIBILIT√Ä WEBXR
      // =============================================================================
      async function checkWebXRSupport() {
        if (!navigator.xr) {
          compatibilityMsg.textContent = '‚ö†Ô∏è WebXR non supportato. Prova con Chrome su Android.';
          startARBtn.disabled = true;
          return false;
        }

        try {
          const supported = await navigator.xr.isSessionSupported('immersive-ar');
          if (!supported) {
            compatibilityMsg.textContent = '‚ö†Ô∏è AR immersiva non supportata su questo dispositivo.';
            startARBtn.disabled = true;
            return false;
          }
          compatibilityMsg.textContent = '‚úÖ Dispositivo compatibile con AR';
          return true;
        } catch (e) {
          compatibilityMsg.textContent = '‚ö†Ô∏è Errore verifica WebXR: ' + e.message;
          startARBtn.disabled = true;
          return false;
        }
      }

      // =============================================================================
      // AVVIO SESSIONE AR
      // =============================================================================
      async function startAR() {
        console.log('üé¨ Avvio sessione AR...');

        try {
          // Richiedi sessione AR con hit-test
          xrSession = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['hit-test'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: { root: document.body }
          });

          console.log('‚úÖ Sessione AR avviata');

          // Nascondi overlay
          markerOverlay.style.display = 'none';

          // Mostra UI AR
          arInstructions.style.display = 'block';
          reticle.style.display = 'block';

          // Setup hit-test
          const viewerSpace = await xrSession.requestReferenceSpace('viewer');
          hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

          // Reference space per posizionamento
          const refSpace = await xrSession.requestReferenceSpace('local');

          // Connetti A-Frame al renderer WebXR
          scene.renderer.xr.setReferenceSpaceType('local');
          await scene.renderer.xr.setSession(xrSession);

          // Loop di rendering per hit-test
          xrSession.requestAnimationFrame(onXRFrame);

          // Gestisci fine sessione
          xrSession.addEventListener('end', onSessionEnd);

        } catch (e) {
          console.error('‚ùå Errore avvio AR:', e);
          webxrError.style.display = 'block';
          webxrError.querySelector('p').textContent = 'Errore: ' + e.message;
        }
      }

      // =============================================================================
      // FRAME LOOP XR - HIT TESTING
      // =============================================================================
      function onXRFrame(time, frame) {
        if (!xrSession || objectsPlaced) return;

        xrSession.requestAnimationFrame(onXRFrame);

        const refSpace = scene.renderer.xr.getReferenceSpace();
        if (!refSpace || !hitTestSource) return;

        // Ottieni risultati hit-test
        const hitTestResults = frame.getHitTestResults(hitTestSource);

        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(refSpace);

          if (pose) {
            // Aggiorna posizione reticolo 3D
            const pos = pose.transform.position;
            reticle3d.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
            reticle3d.setAttribute('visible', 'true');

            // Salva posizione per posizionamento oggetti
            reticlePosition = { x: pos.x, y: pos.y, z: pos.z };

            // Mostra bottone posiziona
            placeObjectsBtn.style.display = 'block';
            arInstructions.textContent = 'Superficie rilevata! Tocca per posizionare gli oggetti.';
          }
        } else {
          reticle3d.setAttribute('visible', 'false');
          placeObjectsBtn.style.display = 'none';
          arInstructions.textContent = 'Muovi il telefono per trovare una superficie piana.';
        }
      }

      // =============================================================================
      // POSIZIONA OGGETTI
      // =============================================================================
      function placeObjects() {
        if (!reticlePosition || objectsPlaced) return;

        console.log('üìç Posiziono oggetti a:', reticlePosition);

        // Posiziona container oggetti nella posizione del reticolo
        arObjects.setAttribute('position',
          `${reticlePosition.x} ${reticlePosition.y} ${reticlePosition.z}`
        );
        arObjects.setAttribute('visible', 'true');

        // Nascondi UI
        reticle3d.setAttribute('visible', 'false');
        reticle.style.display = 'none';
        placeObjectsBtn.style.display = 'none';
        arInstructions.style.display = 'none';

        // Mostra messaggio successo
        showStatus('‚úÖ Oggetti posizionati! Gira intorno per esplorarli.');

        // Mostra debug
        debugToggle.style.display = 'block';

        objectsPlaced = true;

        console.log('‚úÖ Oggetti ancorati allo spazio reale');
      }

      // =============================================================================
      // FINE SESSIONE
      // =============================================================================
      function onSessionEnd() {
        console.log('‚ö†Ô∏è Sessione AR terminata');
        xrSession = null;
        hitTestSource = null;

        // Reset UI
        if (!objectsPlaced) {
          markerOverlay.style.display = 'flex';
        }
        arInstructions.style.display = 'none';
        reticle.style.display = 'none';
        placeObjectsBtn.style.display = 'none';
      }

      // =============================================================================
      // UTILITY
      // =============================================================================
      function showStatus(msg) {
        statusMessage.textContent = msg;
        statusMessage.style.display = 'block';
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 3000);
      }

      // =============================================================================
      // EVENT LISTENERS
      // =============================================================================
      startARBtn.addEventListener('click', startAR);
      placeObjectsBtn.addEventListener('click', placeObjects);

      // Debug mode
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('debug') === 'true') {
        debugToggle.style.display = 'block';
      }

      // Check compatibilit√† all'avvio
      checkWebXRSupport();

      console.log('üì± User Agent:', navigator.userAgent);
    </script>
  </body>
</html>
